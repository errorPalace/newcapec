package net.newcapec.campus.h5.action;

import java.io.IOException;
import java.util.Date;
import java.util.List;
import java.util.UUID;
import java.util.regex.Pattern;

import net.newcapec.campus.h5.entity.VoteClass;
import net.newcapec.campus.h5.entity.VoteSchool;
import net.newcapec.campus.h5.entity.VoteUserInfo;
import net.newcapec.campus.h5.http.HttpCampusUtils;
import net.newcapec.campus.h5.manager.VoteClassManager;
import net.newcapec.campus.h5.manager.VoteSchoolManager;
import net.newcapec.campus.h5.manager.VoteUserInfoManager;
import net.newcapec.campus.h5.util.DateUtil;
import net.newcapec.campus.quickaccess.utils.PreferenceUtils;
import net.newcapec.v3.core.web.action.BaseAction;
import net.newcapec.v3.extend.orm.condition.Conditions;

import org.apache.commons.lang.StringUtils;

import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;

public class VoteAction extends BaseAction {

	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;
	private HttpCampusUtils httpCampusUtils;
	private PreferenceUtils preferenceUtils;
	private VoteUserInfoManager voteUserInfoManager;
	private VoteClassManager voteClassManager;
	private VoteSchoolManager voteSchoolManager;

	public void setVoteSchoolManager(VoteSchoolManager voteSchoolManager) {
		this.voteSchoolManager = voteSchoolManager;
	}

	public VoteClassManager getVoteClassManager() {
		return voteClassManager;
	}

	public void setVoteClassManager(VoteClassManager voteClassManager) {
		this.voteClassManager = voteClassManager;
	}

	public void setVoteUserInfoManager(VoteUserInfoManager voteUserInfoManager) {
		this.voteUserInfoManager = voteUserInfoManager;
	}

	public void setPreferenceUtils(PreferenceUtils preferenceUtils) {
		this.preferenceUtils = preferenceUtils;
	}

	public void setHttpCampusUtils(HttpCampusUtils httpCampusUtils) {
		this.httpCampusUtils = httpCampusUtils;
	}

	// 入口
	public void entrance() throws Exception {
		String token = this.getParameter("token");
		if (StringUtils.isBlank(token)) {
			this.log.info("############################### token为空");
			return;
		}
		JSONObject jsonObject = httpCampusUtils.getUserByTokenSys(token);
		this.log.info("###############################"+jsonObject);
		if (jsonObject == null) {
			this.log.info("############################### token没有获取用户信息失败");
			this.getResponse().sendRedirect(preferenceUtils.getErrorTokenURL());
			return;
		}

		String sex = jsonObject.getString("sex");
		Long userId = jsonObject.getLong("userId");
		String name = jsonObject.getString("name");
		String nickname = jsonObject.getString("nickname");
		String customerCode = jsonObject.getString("customerCode");
		String customerName = jsonObject.getString("customerName");
		boolean bindEcard = jsonObject.getBooleanValue("bindEcard");
		if (!bindEcard) {
			this.log.info("############################### token没有获取用户信息没有绑卡   查看微信问题（进这口必须绑卡的）");
			this.getResponse().sendRedirect(preferenceUtils.getErrorTokenURL());
			return;
		}

		String regex = "^[\\p{L} .'-]+$";
		boolean isName = Pattern.matches(regex, name);
		if (!isName) {
			name = nickname;
		}
		// 先查询本地是否有用户信息
		List<VoteUserInfo> vuiList = voteUserInfoManager.findByCondition(Conditions.eq("userId", userId));
		if (vuiList.isEmpty()) {
			VoteUserInfo vui = new VoteUserInfo();
			vui.setCreateDate(new Date());
			vui.setUserName(name);
			vui.setCustomerCode(customerCode);
			vui.setCustomerName(customerName);
			String uuid = UUID.randomUUID().toString().trim()
					.replaceAll("-", "");// uuid
			vui.setUuid(uuid);
			vui.setUserId(userId);
			vui.setType(false);//
			VoteUserInfo voteUserInfo = voteUserInfoManager.save(vui);

			if (voteUserInfo != null) {
				this.getResponse().sendRedirect(
						preferenceUtils.getVoteRedirectURL() + "?key="+ voteUserInfo.getUuid());
			} else {
				this.getResponse().sendRedirect(
						preferenceUtils.getErrorTokenURL());
			}
		} else {
			this.getResponse().sendRedirect(
					preferenceUtils.getVoteRedirectURL() + "?key="+ vuiList.get(0).getUuid());
		}
	}

	// 获取用户信息
	public void getUserInfo() throws Exception {
		JSONObject result = new JSONObject();
		JSONObject data = new JSONObject();
		String uuid = this.getParameter("key");
		List<VoteUserInfo> voteUserInfoList = voteUserInfoManager.findByCondition(Conditions.eq("uuid", uuid));
		if (voteUserInfoList.isEmpty()) {
			result.put("result_", false);
			result.put("code_", 99);
			result.put("message_", "没有找到该用户的信息！");
			ajaxOutPutText(result.toJSONString());
			return;
		}
		VoteUserInfo voteUserInfo = voteUserInfoList.get(0);
		boolean userVote = voteUserInfo.isType();
		boolean schoolType = true;
		String customerCode = voteUserInfo.getCustomerCode();
		List<VoteClass> voteClassList = voteClassManager.findByCondition(
				Conditions.eq("customerCode", customerCode),
				Conditions.desc("poll"));
		if (voteClassList.isEmpty()) {
			schoolType = false;
		}
		data.put("userVote", userVote);
		data.put("schoolType", schoolType);
		if (schoolType) {
			data.put("mySchoolName", voteUserInfo.getCustomerName());
			JSONArray classList = new JSONArray();
			long sum = 0L;
			long yesterdaySum = 0L;
			for (VoteClass vc : voteClassList) {
				JSONObject jo = new JSONObject();
				jo.put("classId", vc.getId());
				jo.put("className", vc.getClassName());
				int todayCount = voteUserInfoManager.countByCondition(Conditions.eq("classId", vc.getId()));
				int yesterdayCount = voteUserInfoManager.countByCondition(Conditions.eq("classId", vc.getId()),Conditions.lt("voteDate", DateUtil.getStartTime()));
				jo.put("poll", todayCount);
				sum = sum + todayCount;
				yesterdaySum = yesterdaySum + yesterdayCount;
				classList.add(jo);
			}
			data.put("toDayMoney", sum * 0.5);
			data.put("yesterdayAdd", (sum - yesterdaySum) * 0.5);
			data.put("classList", classList);
			if (userVote) {
				if (voteClassList.size() > 5) {
					VoteClass voteClass = voteClassList.get(4);
					long poll5 = voteClass.getPoll();// 第五名的票数
					VoteClass myClass = voteClassManager.get(voteUserInfo.getClassId());
					long myClassPoll = myClass.getPoll();
					long differ5 = poll5 - myClassPoll;
					if (differ5 > 0) {
						data.put("myClassMessage", "距离获得奖金还有" + differ5 + "票");
					} else {
						data.put("myClassMessage", "已进入前5名，继续保持哦");
					}
				} else {
					data.put("myClassMessage", "已进入前5名，继续保持哦");
				}
			}

		} else { // 自己学校没有参数
			List<VoteSchool> schoolAll = voteSchoolManager
					.findByCondition(Conditions.desc("poll"));
			JSONArray JA = new JSONArray();
			for (VoteSchool vs : schoolAll) {
				JSONObject JO = new JSONObject();
				String customerCode1 = vs.getCustomerCode();
				String customerName = vs.getCustomerName();
				long poll = vs.getPoll();
				JO.put("customerCode", customerCode1);
				JO.put("customerName", customerName);
				JO.put("poll", poll);
				JO.put("sunMoney", poll * 0.5);
				int countClass = voteClassManager.countByCondition(Conditions
						.eq("customerCode", vs.getCustomerCode()));
				JO.put("countClass", countClass);
				if (userVote && customerCode1.equals(customerCode)) {
					JO.put("voteSchool", true);
				} else {
					JO.put("voteSchool", false);
				}
				JA.add(JO);
			}
			data.put("schoolList", JA);

		}

		result.put("result_", true);
		result.put("code_", 0);
		result.put("data", data);
		result.put("message_", "成功");
		ajaxOutPutText(result.toJSONString());
		return;

	}

	// 获取全国列表
	public void getAllSchool() throws Exception {
		JSONObject result = new JSONObject();
		JSONObject data = new JSONObject();
		String uuid = this.getParameter("key");
		List<VoteUserInfo> voteUserInfoList = voteUserInfoManager
				.findByCondition(Conditions.eq("uuid", uuid));
		if (voteUserInfoList.isEmpty()) {
			result.put("result_", false);
			result.put("code_", 99);
			result.put("message_", "没有找到该用户的信息！");
			ajaxOutPutText(result.toJSONString());
			return;
		}
		VoteUserInfo voteUserInfo = voteUserInfoList.get(0);
		boolean userVote = voteUserInfo.isType();
		String customerCode = voteUserInfo.getCustomerCode();

		// 自己学校没有参数
		List<VoteSchool> schoolAll = voteSchoolManager
				.findByCondition(Conditions.desc("poll"));
		JSONArray JA = new JSONArray();
		for (VoteSchool vs : schoolAll) {
			JSONObject JO = new JSONObject();
			String customerCode1 = vs.getCustomerCode();
			String customerName = vs.getCustomerName();
			long poll = vs.getPoll();
			JO.put("customerCode", customerCode1);
			JO.put("customerName", customerName);
			JO.put("poll", poll);
			JO.put("sunMoney", poll * 0.5);
			int countClass = voteClassManager.countByCondition(Conditions.eq(
					"customerCode", vs.getCustomerCode()));
			JO.put("countClass", countClass);
			if (userVote && customerCode1.equals(customerCode)) {
				JO.put("voteSchool", true);
			} else {
				JO.put("voteSchool", false);
			}
			JA.add(JO);
		}
		data.put("schoolList", JA);
	}

	// 投票
	public void vote() throws Exception {
		JSONObject result = new JSONObject();
		JSONObject data = new JSONObject();
		String uuid = this.getParameter("key");
		Long classId = this.getLongParameter("classId");
		if (StringUtils.isBlank(uuid) || null == classId) {
			result.put("result_", false);
			result.put("code_", 99);
			result.put("message_", "入口参数错误！");
			ajaxOutPutText(result.toJSONString());
			return;
		}

		JSONObject vote = voteUserInfoManager.vote(uuid, classId);
		ajaxOutPutText(vote.toJSONString());
		return;

	}

	// 根据costomCode获取班级列表
	public void getClassByCostomCode() throws IOException {
		JSONObject result = new JSONObject();
		JSONObject data = new JSONObject();
		String customerCode = this.getParameter("customerCode");
		List<VoteClass> voteClassList = voteClassManager.findByCondition(
				Conditions.eq("customerCode", customerCode),
				Conditions.desc("poll"));
		JSONArray classList = new JSONArray();
		long sum = 0L;
		long yesterdaySum = 0L;
		for (VoteClass vc : voteClassList) {
			JSONObject jo = new JSONObject();
			jo.put("classId", vc.getId());
			jo.put("className", vc.getClassName());
			int todayCount = voteUserInfoManager.countByCondition(Conditions
					.eq("classId", vc.getId()));
			int yesterdayCount = voteUserInfoManager.countByCondition(
					Conditions.eq("classId", vc.getId()),
					Conditions.lt("voteDate", DateUtil.getStartTime()));
			jo.put("poll", todayCount);
			sum = sum + todayCount;
			yesterdaySum = yesterdaySum + yesterdayCount;
			classList.add(jo);
		}
		data.put("toDayMoney", sum * 0.5);
		data.put("yesterdayAdd", (sum - yesterdaySum) * 0.5);
		data.put("classList", classList);
		data.put("customerName", voteClassList.get(0).getCustomerName());

		result.put("result_", true);
		result.put("code_", 0);
		result.put("data", data);
		result.put("message_", "成功");
		ajaxOutPutText(result.toJSONString());
		return;

	}
	// 分享
	public void getVoteShareURL() throws Exception {
		JSONObject result = new JSONObject();
		JSONObject data = new JSONObject();
		String key = this.getParameter("key");
	    String s =	preferenceUtils.getVoteShareURL() + "?key="+ key;
	    result.put("result_", true);
		result.put("code_", 0);
		data.put("shareUrl", s);
		result.put("data", data);
		result.put("message_", "成功");
		ajaxOutPutText(result.toJSONString());
		return;
	
	}
}
